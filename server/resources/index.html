<html>
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.13.0/css/ol.css" type="text/css">
    <link rel="stylesheet" href="resources/style.css" type="text/css">
    <!-- TODO: move this to my server. -->
    <script src="http://openlayers.org/en/v3.13.0/build/ol.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket=io();

    </script>
    <title>piChart</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script type="text/javascript">
      var extent_xmin = 1604600;
      var extent_xmax = 2067400;
      var extent_ymax = 6056100;
      var extent_ymin = 5850000;
      // TODO: insert host name and port automatically.
      var baseURL = "http://raspberrypi.local:8080/resources/tiles/";

      var boat = new ol.Feature( { geometry: new ol.geom.Polygon( [ ] )} );

      var boatPosition = ol.proj.fromLonLat([17.998, 59.03685]);
      var boatHeadingRad = Math.PI * 45 / 180;
      var boatSpeedKnots = 4; // knots

      var myView = new ol.View({
          center: boatPosition, // ol.proj.fromLonLat([18.5, 59.5]),
          zoom: 16,
          maxZoom: 17 });

      document.body.onkeydown = function( e) {
        switch( e.keyCode )
        {
          case 82: // right arrow           // rotate map
            myView.setRotation( myView.getRotation() + 0.05 );
            break;

          case 76:   // 37=left arrow, 76=L
            myView.setRotation( myView.getRotation() - 0.05 );
             break;
      
          case 187: // plus
            // zoom in
            // myView.setZoom( myView.getZoom( ) + 1 );
            myView.setResolution( myView.getResolution( ) * 0.95 );
            break;

          case 189: // minus, zoom out
            // myView.setZoom( myView.getZoom( ) - 1 );
            myView.setResolution( myView.getResolution( ) * 1.05 );
            break;

          default:
            alert(String.fromCharCode(e.keyCode)+" --> "+e.keyCode);
        }
      };

/*
      window.addEventListener("keydown", myScript);
*/
      var extent_chart = [extent_xmin, extent_ymin, extent_xmax, extent_ymax];

      var chartProjection = ol.proj.get( 'EPSG:3857' );

      // alert( "Projection units: " + chartProjection.getUnits() + ", " + chartProjection.getMetersPerUnit() + " meters per unit" );

      var tms_resolutions_2014 = [ 102.39999999999979, 51.19999999999990, 25.59999999999995, 12.79999999999997, 
                                6.39999999999999, 3.19999999999999, 1.60000000000000, 0.80000000000000, 
                                0.40000000000000, 0.20000000000000, 0.10000000000000 ];


      var tmsChart = new ol.layer.Tile({

          preload: 1,
          source: new ol.source.TileImage({
              crossOrigin: null,
              extent: extent_chart,
              projection: chartProjection,
              tileGrid: new ol.tilegrid.TileGrid({
                  extent: extent_chart,
                  // origin: [0, 0],
                  // origin: [extent_ortofoto_2014[0], extent_ortofoto_2014[1]],
                  resolutions: tms_resolutions_2014
                  
              }),
              tileUrlFunction: function(coordinate) {
      
      if (coordinate === null) return undefined;
      
                  // TMS Style URL
                  var z = coordinate[0];
                  var x = coordinate[1];
                  var y = coordinate[2];
                  var url = baseURL+z+'/'+ x +'/'+y +'.png';
                  // var url = 'file:///Users/erlandlewin/charts/data/'+z+'/'+ x +'/'+y +'.png';
                  return url;
              }
          })
      });

      var OSMChartLayer = new ol.layer.Tile({
	  source: new ol.source.OSM({
	      crossOrigin: null,
	      url: baseURL + '{z}/{x}/{y}.png'
	  })
      });

      var XYZChartLayer = new ol.layer.Tile({
	  source: new ol.source.XYZ({
	      // crossOrigin: null,
	      url: baseURL + '{z}/{x}/{-y}.png',
	      maxZoom: 17
	      // tileGrid: new ol.tilegrid.TileGrid( { minZoom: 7, extent: 
	  })
      });
						     
      // Icon stuff for boat

      var boatIconFeature = new ol.Feature({
	  // geometry: new ol.geom.Point([0, 0]),
	  // geometry: new ol.geom.Point( [0, 0]) // ,boatPosition // new ol.geom.Point([0, 0]),
	  geometry: new ol.geom.Point( boatPosition )
	  // geometry: new ol.geom.Point(ol.proj.transform([18.5, 59.5], 'EPSG:4326',
		//			      'EPSG:3857')),
      });

      var boatIcon = new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
	      // anchor: [0.5, 46], // boatPosition,
	      // anchor: [0.5, 0.5], // boatPosition,
	      // anchorXUnits: 'fraction',
	      // anchorYUnits: 'fraction',
	      opacity: 0.75,
	      scale: 1/8,
	      rotation: boatHeadingRad,
	      rotateWithView: true,
	      src: 'resources/sunwind-icon2.svg'
      }));

      var iconStyle = new ol.style.Style({
	  image: boatIcon
      });

      boatIconFeature.setStyle(iconStyle);

    socket.on( 'navInfo', function(msg) {
	// console.log("New COG: " + msg.COG );
        boatIcon.setRotation( msg.COG * Math.PI / 180 );
        boatIconFeature.setGeometry( new ol.geom.Point( ol.proj.fromLonLat( msg.position ) ) );
	// boatIconFeature.changed();
    }  );

      /* Boat speed vector */
      // speed vector length is distance travelled in five minutes
      var knotsToMetersPerSecond = 1852 / 3600;
      var boatSpeedMetersPerSecond = boatSpeedKnots * knotsToMetersPerSecond;
      var fiveMinuteDistance = boatSpeedMetersPerSecond * 5 * 60; // will be 617 meters
      var vectorX = fiveMinuteDistance * Math.sin( boatHeadingRad );
      var vectorY = fiveMinuteDistance * Math.cos( boatHeadingRad );

      // TODO: need to fix vectorX and vectorY in all quadrants
      var vectorEnd = boatPosition.slice(0); // clones the array
      vectorEnd = ol.coordinate.add( vectorEnd, [vectorX, vectorY ] );

      var coordinates = [boatPosition, vectorEnd];
      var boatSpeedFeature = new ol.Feature({
	  geometry: new ol.geom.LineString( coordinates )
	  // geometry: new ol.geom.Point(ol.proj.transform([18.5, 59.5], 'EPSG:4326',
		//			      'EPSG:3857')),
      });

      var iconSource = new ol.source.Vector({
	  features: [ boatIconFeature, boatSpeedFeature]
      });

     var iconLayer = new ol.layer.Vector({
          source: iconSource
     });

      // TODO: test different renderers, see http://openlayers.org/en/v3.0.0/apidoc/ol.Map.html
      var map = new ol.Map({
          controls: [ new ol.control.ScaleLine() ],						     
	  target: 'map',
	  renderer: 'canvas',
          layers: [
	      new ol.layer.Tile({
		  source: new ol.source.OSM()
	      }),
	      // XYZChartLayer,
	      iconLayer,
	      new ol.layer.Tile({
		  source: new ol.source.TileDebug({
		      projection: 'EPSG:3857',
		      tileGrid: new ol.tilegrid.createXYZ({
			  maxZoom: 17
		      })
		  })
	      })
        ],
          view: myView
      });
    </script>

  </body>
</html>
